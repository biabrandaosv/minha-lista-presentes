<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lista de Presentes â€” Bianca & Rebecca</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* Seu CSS permanece igual */
    :root {
      --verde-escuro: #1f3b2f;
      --verde-oliva: #667155;
      --bege: #f5efe6;
      --card-bg: #fff;
      --radius: 14px;
      --shadow: 0 8px 24px rgba(31, 59, 47, 0.08);
      --max-width: 1100px;
    }

    * {
      box-sizing: border-box
    }

    body {
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, var(--bege), #f2efe9);
      color: var(--verde-escuro);
      margin: 0;
      padding: 32px 16px 80px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      justify-content: center;
    }

    .wrap {
      width: 100%;
      max-width: var(--max-width)
    }

    header {
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 18px
    }

    .logo {
      width: 84px;
      height: 84px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--bege);
      font-weight: 700;
      font-size: 20px;
      box-shadow: var(--shadow)
    }

    .title {
      line-height: 1
    }

    .title h1 {
      margin: 0;
      font-size: 20px
    }

    .title p {
      margin: 2px 0 0;
      font-size: 13px;
      color: rgba(31, 59, 47, 0.75)
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 18px
    }

    .controls input[type="search"] {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(31, 59, 47, 0.08);
      width: 240px
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 18px
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .img-wrap {
      height: 160px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .meta {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 8px
    }

    .meta .name {
      font-weight: 600;
      font-size: 16px;
      text-align: center
    }

    .actions {
      margin-top: auto;
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center
    }

    button.presentar {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 0;
      background: #A1AF7A;
      color: white;
      font-weight: 600;
      cursor: pointer
    }

    button.presentar[disabled] {
      opacity: 0.6;
      cursor: not-allowed
    }

    .chosen-badge {
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(184, 92, 58, 0.12);
      color: var(--terracota);
      font-weight: 600;
      font-size: 13px;
      text-align: center
    }

    footer {
      margin-top: 18px;
      text-align: center;
      color: rgba(31, 59, 47, 0.6);
      font-size: 13px
    }

    /* modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.35);
      z-index: 60
    }

    .modal.open {
      display: flex
    }

    .modal-card {
      background: white;
      padding: 18px;
      border-radius: 12px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12)
    }

    .modal-card h3 {
      margin: 0 0 8px
    }

    .modal-row {
      display: flex;
      gap: 8px;
      margin-top: 12px
    }

    input[type="text"],
    input[type="email"] {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(31, 59, 47, 0.08)
    }

    .btn-ghost {
      background: none;
      border: 0;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer
    }

    @media (max-width:520px) {
      .img-wrap {
        height: 140px
      }

      header {
        flex-direction: row;
        gap: 12px
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <img src="logo.png.png" alt="Logo Bianca & Rebecca"
          style="width:100%; height:120%; object-fit:contain; border-radius:16px;">
      </div>

      <div class="title">
        <h1>Lista de Presentes â€” Bianca &amp; Rebecca</h1>
        <p>Obrigada por fazer parte do nosso dia â€” escolha um presente e deixe seu nome ðŸ’š</p>
      </div>
    </header>

    <div class="controls">
      <input id="search" type="search" placeholder="Buscar presente (ex: cafeteira, sofÃ¡)...">
      <div style="margin-left:auto;color:rgba(31,59,47,0.6);font-size:13px">Itens: <span id="count">0</span></div>
    </div>

    <main>
      <section class="grid" id="grid"></section>
    </main>

    <footer>
      Criado especialmente para nosso casamento.
    </footer>
  </div>

  <div class="modal" id="modal">
    <div class="modal-card">
      <h3>Presentear</h3>
      <div id="modal-title" style="color:var(--verde-escuro);font-weight:600;margin-bottom:8px"></div>
      <div style="font-size:13px;color:rgba(31,59,47,0.7)">Digite seu nome para que possamos agradecer :)</div>
      <div class="modal-row">
        <input id="guest-name" type="text" placeholder="Seu nome (ex: JoÃ£o Silva)">
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn-ghost" id="cancel">Cancelar</button>
        <button class="presentar" id="confirm">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Firebase modular via CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, doc, runTransaction, writeBatch
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCPW9WdkXYBPQaA_GQU4EkpjPMn7gVYD2U",
      authDomain: "listabiancarebecca.firebaseapp.com",
      projectId: "listabiancarebecca",
      storageBucket: "listabiancarebecca.firebasestorage.app",
      messagingSenderId: "1000428145304",
      appId: "1:1000428145304:web:a7dc844748e8c89a9b9eed"
    };

    const COLLECTION_NAME = 'presentes';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const initialPresents = [
      { id: 'p1', title: 'Cafeteira Dolce Gusto', img: 'https://a-static.mlcdn.com.br/1500x1500/cafeteira-arno-nescafe-dolce-gusto-mini-me-automatica-preta-127-v-pj120854-dmm0/marciusmagazine/0043220050/191b68f5cf330e4df9eff05f440b9868.jpg' },
      { id: 'p2', title: 'Aspirador RobÃ´', img: 'https://images1.kabum.com.br/produtos/fotos/155321/aspirador-de-po-robo-ir-360-kabum-smart-700-branco_1628769488_gg.jpg' },
      { id: 'p3', title: 'Aspirador de PÃ³', img: 'https://a-static.mlcdn.com.br/1500x1500/aspirador-de-po-e-agua-wap-gtw-10-com-porta-acessorios-1400w-amarelo-e-preto/magazineluiza/219060300/97a89d0a927eb91c1b78129c36282280.jpg' },
      { id: 'p4', title: 'Jogo de Panelas', img: 'https://a-static.mlcdn.com.br/800x560/jogo-de-panelas-10-pecas-2mm-revestimento-ceramico-inducao-antiaderente-mimo-style/feherosshop/9553/3cd2939c58cd30c174fc919d6a19ac60.jpeg' },
      { id: 'p5', title: 'Jogo de Jantar', img: 'https://http2.mlstatic.com/D_NQ_NP_640729-MLB75785388428_042024-O-aparelho-de-jantar-brisa-30-pecas-oxford.webp' },
      { id: 'p6', title: 'Panela de PressÃ£o ElÃ©trica', img: 'https://a-static.mlcdn.com.br/1500x1500/panela-de-pressao-eletrica-mondial-pratic-cook-pe-26-700w-3l-timer-controle-de-temperatura/magazineluiza/023341800/8b2f58d7755f7a33294938faee68a95f.jpg' },
      { id: 'p7', title: 'Panela de Arroz ElÃ©trica', img: 'https://a-static.mlcdn.com.br/1500x1500/panela-de-arroz-eletrica-mondial-fast-rice-5-premium-5-xicaras-400w/magazineluiza/236682100/b49c0403cb9daae5d247bcb263459ccd.jpg' },
      { id: 'p8', title: 'SofÃ¡ Cama de Espuma BouclÃª', img: 'https://http2.mlstatic.com/D_NQ_NP_2X_922334-MLA83178037381_032025-F.webp' },
      { id: 'p9', title: 'Edredom Queen Percal', img: 'https://a-static.mlcdn.com.br/800x560/kit-edredom-queen-percal-180-fios-algodao-03-pecas-bordado-margarida-casaborda-enxovais/oliviaenxovais/00903-branco/99ef47793fbee1b0c022b5f11b551fca.jpeg' },
      { id: 'p10', title: 'Jogo de cama queen', img: 'https://a-static.mlcdn.com.br/800x560/jogo-de-cama-queen-4-pecas-lencol-com-elastico-100-algodao-percal-130-fios-158x198x35cm-dohler/emcompre/414584/6f287a0f04403061d215fea65dde821d.jpeg' },
      { id: 'p11', title: 'Conjunto de xÃ­caras', img: 'https://a-static.mlcdn.com.br/800x560/conjunto-de-xicaras-com-pires-de-cafe-porcelana-xicara-branca-kit-12-pecas-luxo-ceramica-chicvida/astar/18e9b9ea4d4c11f0b19142010a480899/bbe7cb7d32c26af1294b7b2ad11927f5.jpeg' },
      { id: 'p12', title: 'Sousplat Jogo Americano Bordado', img: 'https://a-static.mlcdn.com.br/800x560/sousplat-jogo-americano-bordado-dourado-6-lugares-12-pecas-italia-azul-marinho-padrao/enxovaisibitinga2/2541227-204395-0/1bbc41bd7a8f69a0ade28c0703200b93.jpeg' },
      { id: 'p13', title: 'Jogo americano', img: 'https://homeecia.cdn.magazord.com.br/img/2023/02/produto/3705/americano-fibra-natural-estilo-rustico-30cm-ambiente.jpg?ims=865x865' },
      { id: 'p14', title: 'Cobre leito/colcha casal queen', img: 'https://a-static.mlcdn.com.br/800x560/cobre-leito-colcha-casal-queen-austria-matelado-a-linha-flores-03-pecas-borda-bordados/confeccoeszelimari/79-cl-07-123/bbe6eeede7bf1091e5c0d7a6f8cd82e1.jpeg' },
      { id: 'p15', title: 'Conjunto Cabeceira Modulada', img: 'https://down-br.img.susercontent.com/file/br-11134207-7r98o-m9bh7spa7bpef3.webp' }
      { id: 'p16', title: 'Kit Para Churrasco', img: 'https://http2.mlstatic.com/D_Q_NP_2X_787975-MLU75309625510_032024-R.webp' }
      { id: 'p17', title: 'Conjunto Para Sobremesa', img: 'https://http2.mlstatic.com/D_NQ_NP_712688-MLB85366598021_052025-O.webp' }
    ];

    // LocalStorage fallback
    function saveLocal(data) {
      localStorage.setItem('presentes_local', JSON.stringify(data));
    }
    function loadLocal() {
      try { return JSON.parse(localStorage.getItem('presentes_local')) || null } catch (e) { return null }
    }

    // Garantir dados iniciais no Firestore ou localStorage
    async function ensureInitialData() {
      if (db) {
        const q = query(collection(db, COLLECTION_NAME));
        const snap = await getDocs(q);
        if (snap.empty) {
          const batch = writeBatch(db);
          initialPresents.forEach(p => {
            const ref = doc(db, COLLECTION_NAME, p.id);
            batch.set(ref, { ...p, chosen_by: null, chosen_at: null });
          });
          await batch.commit();
        }
      } else {
        if (!loadLocal()) saveLocal(initialPresents.map(p => ({ ...p, chosen_by: null, chosen_at: null })));
      }
    }

    // Buscar presentes do Firestore ou localStorage
    async function fetchPresents() {
      if (db) {
        const q = query(collection(db, COLLECTION_NAME), orderBy('title'));
        const snap = await getDocs(q);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } else {
        return loadLocal() || initialPresents.map(p => ({ ...p, chosen_by: null, chosen_at: null }));
      }
    }

    // Atualizar escolha do presente
    async function updatePresentChoice(id, chosenBy) {
      const timestamp = new Date().toISOString();
      if (db) {
        const ref = doc(db, COLLECTION_NAME, id);
        await runTransaction(db, async (t) => {
          const docSnap = await t.get(ref);
          if (!docSnap.exists()) throw new Error('Item nÃ£o existe');
          const data = docSnap.data();
          if (data.chosen_by) throw new Error('JÃ¡ escolhido');
          t.update(ref, { chosen_by: chosenBy, chosen_at: timestamp });
        });
      } else {
        const arr = loadLocal() || initialPresents.map(p => ({ ...p, chosen_by: null, chosen_at: null }));
        const idx = arr.findIndex(x => x.id === id);
        if (idx === -1) throw new Error('Item nÃ£o encontrado');
        if (arr[idx].chosen_by) throw new Error('JÃ¡ escolhido');
        arr[idx].chosen_by = chosenBy; arr[idx].chosen_at = timestamp;
        saveLocal(arr);
      }
    }

    const gridEl = document.getElementById('grid');
    const countEl = document.getElementById('count');
    const searchEl = document.getElementById('search');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const guestNameInput = document.getElementById('guest-name');
    const confirmBtn = document.getElementById('confirm');
    const cancelBtn = document.getElementById('cancel');

    let presentsCache = [];
    let currentSelectingId = null;

    function render(presents) {
      gridEl.innerHTML = '';
      presents.forEach(p => {
        const card = document.createElement('article'); card.className = 'card';
        card.innerHTML = `
  <div class="img-wrap">
    <a href="${p.link || '#'}" target="_blank" rel="noopener noreferrer">
      <img src="${p.img}" alt="${escapeHtml(p.title)}" />
    </a>
  </div>
  <div class="meta">
    <div class="name">${escapeHtml(p.title)}</div>
  </div>
  <div class="actions">
    ${p.chosen_by
            ? `<div class="chosen-badge">Presenteado por: ${escapeHtml(p.chosen_by)}</div>`
            : `<button class="presentar" data-id="${p.id}">Presentear</button>`}
  </div>
`;
        gridEl.appendChild(card);
      });
      gridEl.querySelectorAll('button.presentar').forEach(btn => {
        btn.addEventListener('click', () => openModal(btn.dataset.id));
      });
      countEl.textContent = presents.length;
    }

    function escapeHtml(s) {
      return (s + '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;')
    }

    function openModal(id) {
      currentSelectingId = id;
      const p = presentsCache.find(x => x.id === id);
      modalTitle.textContent = p ? p.title : '';
      guestNameInput.value = '';
      modal.classList.add('open');
      guestNameInput.focus();
    }
    function closeModal() {
      modal.classList.remove('open');
      currentSelectingId = null;
    }

    cancelBtn.addEventListener('click', closeModal);

    confirmBtn.addEventListener('click', async () => {
      const name = (guestNameInput.value || '').trim();
      if (!name) {
        guestNameInput.focus();
        return;
      }
      try {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Salvando...';
        await updatePresentChoice(currentSelectingId, name);
        await reloadAndRender();
        closeModal();

        const chosenPresent = presentsCache.find(p => p.id === currentSelectingId);
        if (chosenPresent && chosenPresent.link) {
          window.open(chosenPresent.link, '_blank');
        }
      } catch (e) {
        alert('NÃ£o foi possÃ­vel reservar o presente: ' + (e.message || e));
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirmar';
      }
    });

    async function reloadAndRender() {
      try {
        presentsCache = await fetchPresents();
        applyFilter();
      } catch (e) {
        console.error(e);
        alert('Erro ao carregar presentes: ' + e.message)
      }
    }

    function applyFilter() {
      const q = (searchEl.value || '').toLowerCase().trim();
      const arr = presentsCache.filter(p => p.title.toLowerCase().includes(q));
      render(arr);
    }

    searchEl.addEventListener('input', applyFilter);

    // InicializaÃ§Ã£o
    (async function init() {
      await ensureInitialData();
      await reloadAndRender();

      // Atualizar em tempo real (pode adicionar listener se desejar)
      // Firestore onSnapshot nÃ£o funciona diretamente com modular e async aqui, 
      // entÃ£o vocÃª pode implementar depois se quiser.
    })();
  </script>
</body>

</html>
